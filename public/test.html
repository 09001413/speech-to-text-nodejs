<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>HTML5</title>

</head>

<body>
	<h1>Websocket cookie auth Test Case</h1>
	<p>Please open your browser's JavaScript console</p>
	<script src='speech-recognizer.js'></script>
	<script>

		console.log('mic', Microphone);

		// ncaught RangeError: Offset is outside the bounds of the DataView
		document.addEventListener("DOMContentLoaded", function(event) { 
			//do work

			var options = {
				samplingRate: 16000
			};

			var mic = new Microphone();

			function initSocket(socket) {

				var running = false;

				var session = {
					audio: true,
					video: false
				};

				var audioButton = document.getElementById("audioButton");

				audioButton.onclick = function(evt) {
					if (running) {
						mic.stop();
					} else {
						mic.record();
						running = true;
					}
				};

				mic.onAudio = function(blob) {

					setTimeout( function() {
						socket.send(blob);
					}, 100);

				};


				function onError(err) {
					console.log('audio error: ', err);
				}

				// function initializeRecorder(stream) {
				// 	var audioContext = window.AudioContext;
				// 	var context = new audioContext();
				// 	var audioInput = context.createMediaStreamSource(stream);
				// 	var bufferSize = 4096*2;
				// 	// create a javascript node
				// 	var recorder = context.createScriptProcessor(bufferSize, 1, 1);
				// 	// specify the processing function
				// 	recorder.onaudioprocess = recorderProcess;
				// 	// connect stream to our recorder
				// 	audioInput.connect(recorder);
				// 	// connect our recorder to the previous destination
				// 	recorder.connect(context.destination);
				// 	console.log('setting timeout');
				// 	audioButton.onclick = function(evt) {
				// 		if (running) {
				// 			stream.stop();
				// 		}
				// 	};
				// }
        //
				// function recorderProcess(e) {
				// 	var left = e.inputBuffer.getChannelData(0);
				// 	setTimeout( function() {
				// 		var blob = exportDataBuffer(left);
				// 		socket.send(blob);
				// 	}, 100);
				// }
				// var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        //
				// audioButton.onclick = function(evt) {
				// 	if (!running) {
				// 		navigator.webkitGetUserMedia(session, initializeRecorder, onError);
				// 		running = true;
				// 	}
				// };

			}

			function websocketTest() {
				// Test out websocket
				var wsUrl = 'ws://127.0.0.1:8020/speech-to-text-beta/api/v1/recognize';
				var ws = new WebSocket(wsUrl);
				ws.onopen = function(evt) {
					console.log('ws opened');
					ws.send(JSON.stringify({
						'action': 'start',
						'content-type': 'audio/l16;rate=16000',
						'interim_results': true,
						'continuous': true
					}));
					initSocket(ws);
				};
				ws.onmessage = function(evt) {
					console.log('ws message', evt.data);
				};
				ws.onerror = function(evt) {
					console.log('ws error', evt);
				};
				return ws;
			}
			// function callRESTApi(token) {
				// 	var modelUrl = 'https://stream-d.watsonplatform.net/speech-to-text-beta/api/v1/models';
				// 	var sttRequest = new XMLHttpRequest();
				// 	sttRequest.open("GET", modelUrl, true);
				// 	sttRequest.withCredentials = true;
				// 	sttRequest.setRequestHeader('Accept', 'application/json');
				// 	sttRequest.setRequestHeader('Content-Type', 'application/json');
				// 	sttRequest.setRequestHeader('X-Watson-Authorization-Token', token);
				// 	sttRequest.onload = function(evt) {
					// 		console.log('STT Models ', sttRequest.responseText);
					// 		// We wait until we've given this request a chance to load and (ideally) set the cookie
					// 		// But we get a net::ERR_CONNECTION_REFUSED, apparantly because no cookie is set
					// 		websocketTest();
					// 	};
				// 	sttRequest.send();
				// }
			// // callRESTApi(TOKEN);
			// // Make call to API to try and get cookie
			// var url = '/api/token';
			// var tokenRequest = new XMLHttpRequest();
			// tokenRequest.open("GET", url, true);
			// tokenRequest.onload = function(evt) {
				// 	var token = tokenRequest.responseText;
				// 	console.log('Token ', decodeURIComponent(token));
				//
				// 	callRESTApi(token);
				// }

			websocketTest()


		});

	</script>
</body>
<button style="width: 200px; height: 80px" id="audioButton" >Stop</button>
</html>
